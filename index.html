<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Litematica Material Calculator</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --card-bg: #f5f5f5;
            --border-color: #dddddd;
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --danger-color: #f44336;
            --warning-color: #ff9800;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #f0f0f0;
            --card-bg: #2d2d2d;
            --border-color: #404040;
            --primary-color: #66bb6a;
            --secondary-color: #64b5f6;
            --danger-color: #ef5350;
            --warning-color: #ffb74d;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            color: var(--primary-color);
            font-size: 2.2em;
        }

        .theme-toggle {
            background: none;
            border: 2px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background-color: var(--border-color);
        }

        .github-config {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .github-config h3 {
            margin-bottom: 15px;
            color: var(--secondary-color);
        }

        .config-inputs {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .config-input-group {
            flex: 1;
            min-width: 200px;
        }

        .config-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .config-input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .config-help {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background-color: var(--bg-color);
            border-radius: 5px;
            border-left: 4px solid var(--secondary-color);
        }

        .github-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .status-connected {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-disconnected {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .input-section {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .input-options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            background-color: var(--border-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            color: var(--text-color);
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 15px;
        }

        .file-upload {
            padding: 40px;
            border: 2px dashed var(--border-color);
            border-radius: 5px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .file-upload:hover {
            border-color: var(--primary-color);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
        }

        button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        button.secondary {
            background-color: var(--secondary-color);
        }

        button.secondary:hover {
            background-color: #0b7dda;
        }

        .progress-section {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 10px;
            margin: 30px 0;
            border: 1px solid var(--border-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: var(--bg-color);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .progress-bar {
            height: 25px;
            background-color: var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: center;
        }

        select, input[type="text"] {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-width: 200px;
        }

        .layout-options {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .layout-btn {
            padding: 8px 12px;
            background-color: var(--border-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .layout-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .unit-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .unit-btn {
            padding: 6px 12px;
            background-color: var(--border-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .unit-btn.active {
            background-color: var(--secondary-color);
            color: white;
        }

        .materials-container {
            margin: 30px 0;
        }

        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            display: none;
        }

        .materials-grid.active {
            display: grid;
        }

        .materials-list {
            display: none;
        }

        .materials-list.active {
            display: block;
        }

        .material-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .material-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .material-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .material-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .material-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .material-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .material-stat {
            text-align: center;
            padding: 8px;
            background-color: var(--bg-color);
            border-radius: 5px;
        }

        .material-stat .label {
            font-size: 0.8em;
            color: #666;
        }

        .material-stat .value {
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 5px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .input-group input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .material-row {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            gap: 20px;
        }

        .material-row .material-name {
            flex: 2;
        }

        .material-row .material-counts {
            flex: 3;
            display: flex;
            gap: 20px;
        }

        .material-row .material-actions {
            flex: 1;
            display: flex;
            gap: 10px;
        }

        .share-section {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            border: 1px solid var(--border-color);
        }

        .share-url-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .share-url {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: monospace;
        }

        .copy-btn {
            background-color: var(--secondary-color);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background-color: #4CAF50;
            animation: pulse 2s infinite;
        }

        .status-disconnected {
            background-color: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .layout-options {
                margin-left: 0;
            }
            
            .material-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .material-row .material-counts {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Litematica Material Calculator</h1>
            <div>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span id="theme-icon">Dark</span> Mode
                </button>
            </div>
        </header>

        <!-- GitHub Configuration Section -->
        <div class="github-config" id="github-config-section">
            <h3>GitHub Configuration</h3>
            <div id="github-status" class="github-status"></div>
            <div class="config-inputs">
                <div class="config-input-group">
                    <label for="github-username">GitHub Username</label>
                    <input type="text" id="github-username" placeholder="your-username">
                </div>
                <div class="config-input-group">
                    <label for="github-repo">Repository Name</label>
                    <input type="text" id="github-repo" placeholder="litematica-share" value="litematica-share">
                </div>
                <div class="config-input-group">
                    <label for="github-branch">Branch</label>
                    <input type="text" id="github-branch" placeholder="main" value="main">
                </div>
                <div class="config-input-group">
                    <label for="github-token">GitHub Token</label>
                    <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                </div>
            </div>
            <div class="config-help">
                <strong>How to get your GitHub Token:</strong>
                <ol style="margin-top: 5px; padding-left: 20px;">
                    <li>Go to GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)</li>
                    <li>Click "Generate new token" → "Generate new token (classic)"</li>
                    <li>Select "repo" scope (full control of private repositories)</li>
                    <li>Generate token and copy it immediately</li>
                </ol>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="saveGitHubConfig()">Save Configuration</button>
                <button onclick="testGitHubConnection()" class="secondary">Test Connection</button>
                <button onclick="clearGitHubConfig()" style="background-color: var(--danger-color);">Clear Config</button>
            </div>
        </div>

        <div class="input-section">
            <div class="input-options">
                <button class="tab-button active" onclick="switchTab('upload')">File Upload</button>
                <button class="tab-button" onclick="switchTab('ascii')">ASCII Text</button>
                <button class="tab-button" onclick="switchTab('csv')">CSV Text</button>
            </div>

            <div id="upload-tab" class="tab-content active">
                <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                    <p>Drag file here or click to upload</p>
                    <p><small>Supported formats: .txt, .csv</small></p>
                </div>
                <input type="file" id="fileInput" accept=".txt,.csv" style="display: none;" onchange="handleFileUpload(event)">
            </div>

            <div id="ascii-tab" class="tab-content">
                <textarea id="asciiInput" placeholder="Paste your ASCII material list here..."></textarea>
                <button onclick="parseAscii()">Parse ASCII List</button>
            </div>

            <div id="csv-tab" class="tab-content">
                <textarea id="csvInput" placeholder="Paste your CSV material list here..."></textarea>
                <button onclick="parseCSV()">Parse CSV List</button>
            </div>

            <div class="controls">
                <button onclick="resetAll()">Reset All</button>
                <button onclick="clearCollected()">Clear Collected</button>
                <button class="secondary" onclick="checkAll()">Check All</button>
                <button class="secondary" onclick="uncheckAll()">Uncheck All</button>
            </div>
        </div>

        <div class="progress-section">
            <h2>Progress</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div>Total Needed</div>
                    <div class="stat-value" id="total-needed">0</div>
                </div>
                <div class="stat-card">
                    <div>Collected</div>
                    <div class="stat-value" id="total-collected">0</div>
                </div>
                <div class="stat-card">
                    <div>Missing</div>
                    <div class="stat-value" id="total-missing">0</div>
                </div>
                <div class="stat-card">
                    <div>Progress</div>
                    <div class="stat-value" id="progress-percent">0%</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill">0%</div>
            </div>
        </div>

        <div class="filters">
            <select id="sortFilter" onchange="filterMaterials()">
                <option value="all">All Items</option>
                <option value="missing">Missing Only</option>
                <option value="collected">Collected Only</option>
                <option value="most">Most Needed</option>
                <option value="least">Least Needed</option>
            </select>
            <input type="text" id="searchInput" placeholder="Search items..." oninput="filterMaterials()">
            <div class="unit-selector">
                <span>Units:</span>
                <button class="unit-btn active" onclick="changeUnit('items')">Items</button>
                <button class="unit-btn" onclick="changeUnit('stacks')">Stacks</button>
                <button class="unit-btn" onclick="changeUnit('shulker')">Shulker</button>
                <button class="unit-btn" onclick="changeUnit('double')">Double Chest</button>
            </div>
            <div class="layout-options">
                <button class="layout-btn active" onclick="changeLayout('grid')">Grid View</button>
                <button class="layout-btn" onclick="changeLayout('list')">List View</button>
            </div>
        </div>

        <div class="materials-container">
            <div id="materials-grid" class="materials-grid active">
                <!-- Material cards will be inserted here -->
            </div>
            <div id="materials-list" class="materials-list">
                <!-- Material rows will be inserted here -->
            </div>
            <div id="empty-state" class="empty-state" style="display: none;">
                <h3>No Materials Loaded</h3>
                <p>Upload a Litematica material list or paste it as text</p>
            </div>
        </div>

        <div class="share-section">
            <h2>Share & Sync (GitHub)</h2>
            <p>
                <span class="status-indicator" id="status-indicator"></span>
                <span id="status-text">Not connected</span>
            </p>
            <button onclick="createShare()" id="create-share-btn">Create Share Link</button>
            <div class="share-url-container">
                <input type="text" id="shareUrl" class="share-url" readonly placeholder="Share URL will be generated...">
                <button class="copy-btn" onclick="copyShareUrl()">Copy</button>
            </div>
            <div class="input-group" style="margin-top: 15px;">
                <input type="text" id="joinShareId" placeholder="Share ID to join">
                <button onclick="joinShare()">Join Share</button>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="deleteShare()" style="background-color: var(--danger-color); margin-right: 10px;">Delete Share</button>
                <button onclick="stopSharing()" style="background-color: var(--warning-color);">Leave Share</button>
            </div>
        </div>

        <div class="export-options">
            <button onclick="exportAs('ascii')">Export as ASCII</button>
            <button onclick="exportAs('csv')">Export as CSV</button>
            <button onclick="exportAs('json')">Export as JSON</button>
        </div>
    </div>

    <script>
        // GitHub Configuration
        const GITHUB_CONFIG = {
            username: '',
            repo: '',
            branch: 'main',
            token: ''
        };

        // Global variables
        let materials = [];
        let filteredMaterials = [];
        let currentUnit = 'items';
        let currentLayout = 'grid';
        let shareId = null;
        let isHost = false;
        let lastSha = null;
        let pollInterval = null;
        let lastSyncTime = 0;
        let syncInProgress = false;

        // Initialize GitHub config from localStorage
        function loadGitHubConfig() {
            const savedConfig = localStorage.getItem('github_config');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                GITHUB_CONFIG.username = config.username || '';
                GITHUB_CONFIG.repo = config.repo || '';
                GITHUB_CONFIG.branch = config.branch || 'main';
                GITHUB_CONFIG.token = config.token || '';
                
                // Update UI
                document.getElementById('github-username').value = GITHUB_CONFIG.username;
                document.getElementById('github-repo').value = GITHUB_CONFIG.repo;
                document.getElementById('github-branch').value = GITHUB_CONFIG.branch;
                document.getElementById('github-token').value = GITHUB_CONFIG.token;
                
                updateGitHubStatus('Configuration loaded', true);
                return true;
            }
            return false;
        }

        // Save GitHub config to localStorage
        function saveGitHubConfig() {
            GITHUB_CONFIG.username = document.getElementById('github-username').value.trim();
            GITHUB_CONFIG.repo = document.getElementById('github-repo').value.trim();
            GITHUB_CONFIG.branch = document.getElementById('github-branch').value.trim() || 'main';
            GITHUB_CONFIG.token = document.getElementById('github-token').value.trim();
            
            if (!GITHUB_CONFIG.username || !GITHUB_CONFIG.repo || !GITHUB_CONFIG.token) {
                alert('Please fill in all fields: Username, Repository, and Token');
                return;
            }
            
            localStorage.setItem('github_config', JSON.stringify(GITHUB_CONFIG));
            updateGitHubStatus('Configuration saved', true);
            alert('GitHub configuration saved successfully!');
        }

        // Clear GitHub config
        function clearGitHubConfig() {
            if (confirm('Are you sure you want to clear your GitHub configuration?')) {
                localStorage.removeItem('github_config');
                GITHUB_CONFIG.username = '';
                GITHUB_CONFIG.repo = '';
                GITHUB_CONFIG.branch = 'main';
                GITHUB_CONFIG.token = '';
                
                document.getElementById('github-username').value = '';
                document.getElementById('github-repo').value = '';
                document.getElementById('github-branch').value = 'main';
                document.getElementById('github-token').value = '';
                
                updateGitHubStatus('Configuration cleared', false);
                stopPolling();
                stopSharing();
            }
        }

        // Test GitHub connection
        async function testGitHubConnection() {
            if (!GITHUB_CONFIG.username || !GITHUB_CONFIG.repo || !GITHUB_CONFIG.token) {
                alert('Please save your configuration first');
                return;
            }
            
            updateGitHubStatus('Testing connection...', false);
            
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}`,
                    {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.ok) {
                    updateGitHubStatus('✓ Connection successful!', true);
                } else if (response.status === 404) {
                    updateGitHubStatus('✗ Repository not found', false);
                    alert('Repository not found. Please check the username and repository name.');
                } else if (response.status === 401) {
                    updateGitHubStatus('✗ Invalid token', false);
                    alert('Invalid GitHub token. Please check your token and make sure it has "repo" scope.');
                } else {
                    updateGitHubStatus(`✗ Error: ${response.status}`, false);
                }
            } catch (error) {
                updateGitHubStatus('✗ Connection failed', false);
                console.error('Connection test error:', error);
            }
        }

        // Update GitHub status display
        function updateGitHubStatus(message, connected) {
            const statusDiv = document.getElementById('github-status');
            statusDiv.textContent = message;
            statusDiv.className = `github-status ${connected ? 'status-connected' : 'status-disconnected'}`;
        }

        // GitHub API request helper
        async function githubApiRequest(endpoint, method = 'GET', data = null) {
            if (!GITHUB_CONFIG.username || !GITHUB_CONFIG.repo || !GITHUB_CONFIG.token) {
                throw new Error('GitHub configuration incomplete');
            }
            
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${endpoint}`;
            
            const options = {
                method: method,
                headers: {
                    'Authorization': `token ${GITHUB_CONFIG.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(url, options);
                
                // Handle rate limiting
                if (response.status === 403 && response.headers.get('X-RateLimit-Remaining') === '0') {
                    const resetTime = new Date(parseInt(response.headers.get('X-RateLimit-Reset')) * 1000);
                    throw new Error(`GitHub API rate limit exceeded. Resets at ${resetTime.toLocaleTimeString()}`);
                }
                
                if (response.status === 404) {
                    return null;
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`GitHub API Error ${response.status}: ${errorText}`);
                }
                
                if (method !== 'DELETE') {
                    return await response.json();
                }
                return true;
            } catch (error) {
                console.error('GitHub API request failed:', error);
                updateStatus(`API Error: ${error.message}`, false);
                throw error;
            }
        }

        // Create a new share
        async function createShare() {
            if (!GITHUB_CONFIG.token) {
                alert('Please configure GitHub first');
                document.getElementById('github-config-section').scrollIntoView();
                return;
            }
            
            if (materials.length === 0) {
                alert('Please load a material list first');
                return;
            }
            
            shareId = 'share_' + Math.random().toString(36).substr(2, 9);
            isHost = true;
            
            const url = `${window.location.origin}${window.location.pathname}?share=${shareId}`;
            document.getElementById('shareUrl').value = url;
            
            // Prepare share data
            const shareData = {
                materials: materials,
                created: Date.now(),
                updated: Date.now(),
                host: true,
                version: 1
            };
            
            // Base64 encode for GitHub
            const content = btoa(JSON.stringify(shareData, null, 2));
            
            try {
                // Check if file exists first
                const existingFile = await githubApiRequest(`contents/shares/${shareId}.json`);
                
                let result;
                if (existingFile) {
                    // Update existing file
                    result = await githubApiRequest(`contents/shares/${shareId}.json`, 'PUT', {
                        message: `Update share: ${shareId}`,
                        content: content,
                        sha: existingFile.sha,
                        branch: GITHUB_CONFIG.branch
                    });
                } else {
                    // Create new file
                    result = await githubApiRequest(`contents/shares/${shareId}.json`, 'PUT', {
                        message: `Create share: ${shareId}`,
                        content: content,
                        branch: GITHUB_CONFIG.branch
                    });
                }
                
                if (result) {
                    lastSha = result.content.sha;
                    updateStatus('Connected (Host)', true);
                    
                    // Start polling for updates
                    startPolling();
                    
                    // Update URL
                    window.history.pushState({}, '', `?share=${shareId}`);
                    
                    alert('Share created successfully!');
                }
            } catch (error) {
                console.error('Error creating share:', error);
                alert(`Failed to create share: ${error.message}`);
            }
        }

        // Join an existing share
        async function joinShare() {
            const id = document.getElementById('joinShareId').value.trim();
            if (!id) {
                alert('Please enter a share ID');
                return;
            }
            
            if (!GITHUB_CONFIG.token) {
                alert('Please configure GitHub first');
                document.getElementById('github-config-section').scrollIntoView();
                return;
            }
            
            shareId = id;
            isHost = false;
            const url = `${window.location.origin}${window.location.pathname}?share=${shareId}`;
            document.getElementById('shareUrl').value = url;
            
            try {
                // Load share from GitHub
                const result = await githubApiRequest(`contents/shares/${shareId}.json`);
                
                if (!result || !result.content) {
                    alert('Share not found. Please check the share ID.');
                    return;
                }
                
                const shareData = JSON.parse(atob(result.content));
                
                if (shareData.materials) {
                    materials = shareData.materials;
                    lastSha = result.sha;
                    
                    updateStats();
                    filterMaterials();
                    renderMaterials();
                    
                    updateStatus('Connected', true);
                    
                    // Start polling
                    startPolling();
                    
                    // Update URL
                    window.history.pushState({}, '', `?share=${shareId}`);
                    
                    alert('Successfully joined share!');
                } else {
                    alert('Invalid share data format.');
                }
            } catch (error) {
                console.error('Error joining share:', error);
                alert(`Failed to join share: ${error.message}`);
            }
        }

        // Sync with GitHub
        async function syncWithServer() {
            if (!shareId || !GITHUB_CONFIG.token || syncInProgress) return;
            
            syncInProgress = true;
            lastSyncTime = Date.now();
            
            try {
                // Get current file to get SHA
                const currentFile = await githubApiRequest(`contents/shares/${shareId}.json`);
                if (!currentFile) {
                    console.error('Share file not found during sync');
                    syncInProgress = false;
                    return;
                }
                
                // Prepare updated data
                const shareData = {
                    materials: materials,
                    created: currentFile.content ? JSON.parse(atob(currentFile.content)).created : Date.now(),
                    updated: Date.now(),
                    host: isHost,
                    version: 1
                };
                
                const content = btoa(JSON.stringify(shareData, null, 2));
                
                // Update file on GitHub
                const result = await githubApiRequest(`contents/shares/${shareId}.json`, 'PUT', {
                    message: `Update: ${shareId} @ ${new Date().toLocaleTimeString()}`,
                    content: content,
                    sha: currentFile.sha,
                    branch: GITHUB_CONFIG.branch
                });
                
                if (result) {
                    lastSha = result.content.sha;
                    updateStatus('Synced', true);
                }
            } catch (error) {
                console.error('Sync error:', error);
                updateStatus('Sync failed', false);
            } finally {
                syncInProgress = false;
            }
        }

        // Check for updates from GitHub
        async function checkForUpdates() {
            if (!shareId || !GITHUB_CONFIG.token) return;
            
            try {
                const result = await githubApiRequest(`contents/shares/${shareId}.json`);
                
                if (!result || !result.sha) {
                    console.log('Share file not found during poll');
                    return;
                }
                
                // Check if file has changed
                if (result.sha !== lastSha) {
                    const shareData = JSON.parse(atob(result.content));
                    
                    // Only update if the data is newer than our last sync
                    if (shareData.updated > lastSyncTime || !isHost) {
                        materials = shareData.materials;
                        lastSha = result.sha;
                        
                        updateStats();
                        filterMaterials();
                        renderMaterials();
                        
                        updateStatus('Updated from server', true);
                        console.log('Updated from GitHub');
                    }
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }

        // Start polling for updates
        function startPolling() {
            stopPolling();
            
            // Initial check
            checkForUpdates();
            
            // Poll every 3 seconds
            pollInterval = setInterval(checkForUpdates, 3000);
        }

        // Stop polling
        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        // Delete a share
        async function deleteShare() {
            if (!shareId || !GITHUB_CONFIG.token) {
                alert('No active share to delete');
                return;
            }
            
            if (!isHost) {
                alert('Only the host can delete a share');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this share? This cannot be undone.')) {
                return;
            }
            
            try {
                const currentFile = await githubApiRequest(`contents/shares/${shareId}.json`);
                
                if (currentFile) {
                    await githubApiRequest(`contents/shares/${shareId}.json`, 'DELETE', {
                        message: `Delete share: ${shareId}`,
                        sha: currentFile.sha,
                        branch: GITHUB_CONFIG.branch
                    });
                    
                    alert('Share deleted successfully');
                    stopSharing();
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert(`Failed to delete share: ${error.message}`);
            }
        }

        // Stop sharing
        function stopSharing() {
            stopPolling();
            
            shareId = null;
            isHost = false;
            lastSha = null;
            
            document.getElementById('shareUrl').value = '';
            document.getElementById('joinShareId').value = '';
            updateStatus('Not connected', false);
            
            // Remove share parameter from URL
            const url = new URL(window.location);
            url.searchParams.delete('share');
            window.history.pushState({}, '', url.toString());
        }

        // Update status display
        function updateStatus(message, connected) {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            
            if (indicator && text) {
                indicator.className = 'status-indicator ' + (connected ? 'status-connected' : 'status-disconnected');
                text.textContent = message;
            }
        }

        // Copy share URL to clipboard
        function copyShareUrl() {
            const urlInput = document.getElementById('shareUrl');
            if (!urlInput.value) {
                alert('No share URL to copy');
                return;
            }
            
            urlInput.select();
            document.execCommand('copy');
            
            // Visual feedback
            const originalText = urlInput.placeholder;
            urlInput.placeholder = 'URL copied!';
            setTimeout(() => {
                urlInput.placeholder = originalText;
            }, 2000);
        }

        // Check URL parameters on load
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const shareParam = urlParams.get('share');
            
            if (shareParam) {
                shareId = shareParam;
                document.getElementById('shareUrl').value = window.location.href;
                document.getElementById('joinShareId').value = shareId;
                
                // Auto-join if we have config
                if (GITHUB_CONFIG.token) {
                    setTimeout(() => autoJoinShare(), 1000);
                }
            }
        }

        // Auto-join share from URL
        async function autoJoinShare() {
            if (!shareId || !GITHUB_CONFIG.token) return;
            
            try {
                const result = await githubApiRequest(`contents/shares/${shareId}.json`);
                
                if (result && result.content) {
                    const shareData = JSON.parse(atob(result.content));
                    
                    if (shareData.materials) {
                        materials = shareData.materials;
                        lastSha = result.sha;
                        
                        updateStats();
                        filterMaterials();
                        renderMaterials();
                        
                        updateStatus('Connected (from URL)', true);
                        startPolling();
                    }
                } else {
                    updateStatus('Share not found', false);
                }
            } catch (error) {
                console.error('Auto-join error:', error);
                updateStatus('Failed to load share', false);
            }
        }

        // File upload handler
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                if (file.name.endsWith('.txt')) {
                    document.getElementById('asciiInput').value = content;
                    parseAscii();
                } else if (file.name.endsWith('.csv')) {
                    document.getElementById('csvInput').value = content;
                    parseCSV();
                }
            };
            reader.readAsText(file);
        }

        // ASCII parser
        function parseAscii() {
            const asciiText = document.getElementById('asciiInput').value;
            const lines = asciiText.split('\n');
            materials = [];

            lines.forEach(line => {
                if (line.includes('|') && !line.includes('+---') && !line.includes('Material List')) {
                    const parts = line.split('|').filter(part => part.trim() !== '');
                    if (parts.length >= 4) {
                        const item = parts[0].trim();
                        const total = parseInt(parts[1].trim()) || 0;
                        const missing = parseInt(parts[2].trim()) || total;
                        
                        if (item && total > 0) {
                            materials.push({
                                name: item,
                                total: total,
                                collected: total - missing,
                                missing: missing,
                                checked: (total - missing) > 0
                            });
                        }
                    }
                }
            });

            if (materials.length === 0) {
                alert('No materials found in ASCII file. Please check the format.');
                return;
            }

            initializeMaterials();
        }

        // CSV parser
        function parseCSV() {
            const csvText = document.getElementById('csvInput').value;
            const lines = csvText.split('\n');
            materials = [];

            lines.forEach((line, index) => {
                if (index === 0) return;
                
                const regex = /"([^"]+)"|([^,]+)/g;
                const matches = [...line.matchAll(regex)];
                const parts = matches.map(match => match[1] || match[2]);

                if (parts.length >= 4) {
                    const item = parts[0].trim();
                    const total = parseInt(parts[1].trim()) || 0;
                    const missing = parseInt(parts[2].trim()) || total;
                    
                    if (item && total > 0) {
                        materials.push({
                            name: item,
                            total: total,
                            collected: total - missing,
                            missing: missing,
                            checked: (total - missing) > 0
                        });
                    }
                }
            });

            if (materials.length === 0) {
                alert('No materials found in CSV file. Please check the format.');
                return;
            }

            initializeMaterials();
        }

        // Initialize materials
        function initializeMaterials() {
            updateStats();
            filterMaterials();
            document.getElementById('empty-state').style.display = 'none';
        }

        // Unit conversion
        function formatCount(count) {
            switch(currentUnit) {
                case 'stacks':
                    const stacks = Math.floor(count / 64);
                    const items = count % 64;
                    return items > 0 ? `${stacks} Stacks + ${items}` : `${stacks} Stacks`;
                case 'shulker':
                    const shulkers = Math.floor(count / 1728);
                    const remainderShulker = count % 1728;
                    const stacksFromShulker = Math.floor(remainderShulker / 64);
                    const itemsFromShulker = remainderShulker % 64;
                    let result = '';
                    if (shulkers > 0) result += `${shulkers} Shulker`;
                    if (stacksFromShulker > 0) result += `${result ? ' + ' : ''}${stacksFromShulker} Stacks`;
                    if (itemsFromShulker > 0) result += `${result ? ' + ' : ''}${itemsFromShulker}`;
                    return result || '0';
                case 'double':
                    const doubleChests = Math.floor(count / (1728 * 2));
                    const remainderDouble = count % (1728 * 2);
                    const shulkersFromDouble = Math.floor(remainderDouble / 1728);
                    const remainderDouble2 = remainderDouble % 1728;
                    const stacksFromDouble = Math.floor(remainderDouble2 / 64);
                    const itemsFromDouble = remainderDouble2 % 64;
                    let resultDouble = '';
                    if (doubleChests > 0) resultDouble += `${doubleChests} Double Chests`;
                    if (shulkersFromDouble > 0) resultDouble += `${resultDouble ? ' + ' : ''}${shulkersFromDouble} Shulker`;
                    if (stacksFromDouble > 0) resultDouble += `${resultDouble ? ' + ' : ''}${stacksFromDouble} Stacks`;
                    if (itemsFromDouble > 0) resultDouble += `${resultDouble ? ' + ' : ''}${itemsFromDouble}`;
                    return resultDouble || '0';
                default:
                    return count.toString();
            }
        }

        // Change layout
        function changeLayout(layout) {
            currentLayout = layout;
            document.querySelectorAll('.layout-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderMaterials();
        }

        // Change unit
        function changeUnit(unit) {
            currentUnit = unit;
            document.querySelectorAll('.unit-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderMaterials();
            updateStats();
        }

        // Filter and sort materials
        function filterMaterials() {
            const filter = document.getElementById('sortFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            filteredMaterials = materials.filter(material => {
                const matchesSearch = material.name.toLowerCase().includes(search);
                
                switch(filter) {
                    case 'missing':
                        return matchesSearch && material.missing > 0;
                    case 'collected':
                        return matchesSearch && material.collected > 0;
                    default:
                        return matchesSearch;
                }
            });

            // Sorting
            switch(filter) {
                case 'most':
                    filteredMaterials.sort((a, b) => b.total - a.total);
                    break;
                case 'least':
                    filteredMaterials.sort((a, b) => a.total - b.total);
                    break;
                default:
                    filteredMaterials.sort((a, b) => b.total - a.total);
            }

            renderMaterials();
        }

        // Render materials
        function renderMaterials() {
            const gridContainer = document.getElementById('materials-grid');
            const listContainer = document.getElementById('materials-list');
            
            if (filteredMaterials.length === 0) {
                gridContainer.innerHTML = '';
                listContainer.innerHTML = '';
                document.getElementById('empty-state').style.display = 'block';
                return;
            }

            document.getElementById('empty-state').style.display = 'none';

            if (currentLayout === 'grid') {
                gridContainer.classList.add('active');
                listContainer.classList.remove('active');
                renderGridLayout();
            } else {
                gridContainer.classList.remove('active');
                listContainer.classList.add('active');
                renderListLayout();
            }
        }

        function renderGridLayout() {
            const container = document.getElementById('materials-grid');
            container.innerHTML = '';

            filteredMaterials.forEach((material, index) => {
                const card = document.createElement('div');
                card.className = 'material-card';
                card.innerHTML = `
                    <div class="material-header">
                        <div class="material-name">${material.name}</div>
                        <input type="checkbox" class="material-checkbox" 
                               ${material.checked ? 'checked' : ''}
                               onchange="toggleMaterial(${index}, this.checked)">
                    </div>
                    <div class="material-stats">
                        <div class="material-stat">
                            <div class="label">Total</div>
                            <div class="value">${formatCount(material.total)}</div>
                        </div>
                        <div class="material-stat">
                            <div class="label">Collected</div>
                            <div class="value">${formatCount(material.collected)}</div>
                        </div>
                        <div class="material-stat">
                            <div class="label">Missing</div>
                            <div class="value">${formatCount(material.missing)}</div>
                        </div>
                        <div class="material-stat">
                            <div class="label">Progress</div>
                            <div class="value">${Math.round((material.collected / material.total) * 100)}%</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <input type="number" 
                               value="${material.collected}"
                               min="0" 
                               max="${material.total}"
                               onchange="updateCollected(${index}, this.value)"
                               placeholder="Amount">
                        <button onclick="setToMax(${index})">Max</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderListLayout() {
            const container = document.getElementById('materials-list');
            container.innerHTML = '';

            filteredMaterials.forEach((material, index) => {
                const row = document.createElement('div');
                row.className = 'material-row';
                row.innerHTML = `
                    <div class="material-name">${material.name}</div>
                    <div class="material-counts">
                        <div>Total: ${formatCount(material.total)}</div>
                        <div>Collected: ${formatCount(material.collected)}</div>
                        <div>Missing: ${formatCount(material.missing)}</div>
                        <div>${Math.round((material.collected / material.total) * 100)}%</div>
                    </div>
                    <div class="material-actions">
                        <input type="checkbox" 
                               ${material.checked ? 'checked' : ''}
                               onchange="toggleMaterial(${index}, this.checked)">
                        <input type="number" 
                               value="${material.collected}"
                               min="0" 
                               max="${material.total}"
                               style="width: 80px;"
                               onchange="updateCollected(${index}, this.value)">
                        <button onclick="setToMax(${index})">Max</button>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        // Toggle material
        function toggleMaterial(index, checked) {
            const materialIndex = materials.findIndex(m => m.name === filteredMaterials[index].name);
            if (materialIndex !== -1) {
                if (checked) {
                    materials[materialIndex].collected = materials[materialIndex].total;
                    materials[materialIndex].missing = 0;
                } else {
                    materials[materialIndex].collected = 0;
                    materials[materialIndex].missing = materials[materialIndex].total;
                }
                materials[materialIndex].checked = checked;
                updateStats();
                filterMaterials();
                if (shareId) syncWithServer();
            }
        }

        // Update collected amount
        function updateCollected(index, value) {
            const materialIndex = materials.findIndex(m => m.name === filteredMaterials[index].name);
            if (materialIndex !== -1) {
                const newCollected = Math.min(Math.max(parseInt(value) || 0, 0), materials[materialIndex].total);
                materials[materialIndex].collected = newCollected;
                materials[materialIndex].missing = materials[materialIndex].total - newCollected;
                materials[materialIndex].checked = newCollected > 0;
                updateStats();
                filterMaterials();
                if (shareId) syncWithServer();
            }
        }

        // Set to maximum
        function setToMax(index) {
            const materialIndex = materials.findIndex(m => m.name === filteredMaterials[index].name);
            if (materialIndex !== -1) {
                materials[materialIndex].collected = materials[materialIndex].total;
                materials[materialIndex].missing = 0;
                materials[materialIndex].checked = true;
                updateStats();
                filterMaterials();
                if (shareId) syncWithServer();
            }
        }

        // Update statistics
        function updateStats() {
            let totalNeeded = 0;
            let totalCollected = 0;
            let totalMissing = 0;

            materials.forEach(material => {
                totalNeeded += material.total;
                totalCollected += material.collected;
                totalMissing += material.missing;
            });

            const progressPercent = totalNeeded > 0 ? Math.round((totalCollected / totalNeeded) * 100) : 0;

            document.getElementById('total-needed').textContent = formatCount(totalNeeded);
            document.getElementById('total-collected').textContent = formatCount(totalCollected);
            document.getElementById('total-missing').textContent = formatCount(totalMissing);
            document.getElementById('progress-percent').textContent = progressPercent + '%';
            document.getElementById('progress-fill').textContent = progressPercent + '%';
            document.getElementById('progress-fill').style.width = progressPercent + '%';
        }

        // Utility functions
        function checkAll() {
            materials.forEach(material => {
                material.collected = material.total;
                material.missing = 0;
                material.checked = true;
            });
            updateStats();
            filterMaterials();
            if (shareId) syncWithServer();
        }

        function uncheckAll() {
            materials.forEach(material => {
                material.collected = 0;
                material.missing = material.total;
                material.checked = false;
            });
            updateStats();
            filterMaterials();
            if (shareId) syncWithServer();
        }

        function clearCollected() {
            materials.forEach(material => {
                material.collected = 0;
                material.missing = material.total;
                material.checked = false;
            });
            updateStats();
            filterMaterials();
            if (shareId) syncWithServer();
        }

        function resetAll() {
            materials = [];
            filteredMaterials = [];
            stopSharing();
            document.getElementById('asciiInput').value = '';
            document.getElementById('csvInput').value = '';
            updateStatus('Not connected', false);
            renderMaterials();
            updateStats();
            document.getElementById('empty-state').style.display = 'block';
        }

        // Export functions
        function exportAs(format) {
            if (materials.length === 0) {
                alert('No materials to export');
                return;
            }
            
            let content = '';
            const filename = `litematica_materials_${new Date().toISOString().split('T')[0]}`;

            switch(format) {
                case 'ascii':
                    content = generateAsciiExport();
                    downloadFile(filename + '.txt', content);
                    break;
                case 'csv':
                    content = generateCSVExport();
                    downloadFile(filename + '.csv', content);
                    break;
                case 'json':
                    content = JSON.stringify({
                        materials: materials,
                        timestamp: new Date().toISOString(),
                        stats: getCurrentStats()
                    }, null, 2);
                    downloadFile(filename + '.json', content);
                    break;
            }
        }

        function generateAsciiExport() {
            let output = '+---------------------------+-------+---------+---------------------+\n';
            output += '| Material List (exported)                   |\n';
            output += '+---------------------------+-------+---------+---------------------+\n';
            output += '| Item                      | Total | Missing | Collected |\n';
            output += '+---------------------------+-------+---------+---------------------+\n';
            
            materials.forEach(material => {
                const name = material.name.padEnd(25);
                const total = material.total.toString().padStart(5);
                const missing = material.missing.toString().padStart(7);
                const collected = material.collected.toString().padStart(9);
                output += `| ${name} | ${total} | ${missing} | ${collected} |\n`;
            });
            
            output += '+---------------------------+-------+---------+---------------------+\n';
            return output;
        }

        function generateCSVExport() {
            let output = '"Item","Total","Missing","Collected"\n';
            materials.forEach(material => {
                output += `"${material.name}",${material.total},${material.missing},${material.collected}\n`;
            });
            return output;
        }

        function getCurrentStats() {
            let totalNeeded = 0;
            let totalCollected = 0;
            materials.forEach(m => {
                totalNeeded += m.total;
                totalCollected += m.collected;
            });
            return {
                totalNeeded,
                totalCollected,
                progress: totalNeeded > 0 ? (totalCollected / totalNeeded) * 100 : 0
            };
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Theme toggle
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const icon = document.getElementById('theme-icon');
            
            if (currentTheme === 'dark') {
                document.documentElement.removeAttribute('data-theme');
                icon.textContent = 'Dark';
                event.target.innerHTML = 'Dark Mode';
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                icon.textContent = 'Light';
                event.target.innerHTML = 'Light Mode';
            }
        }

        // Tab switch function
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load GitHub config
            loadGitHubConfig();
            
            // Check URL parameters
            checkUrlParams();
            
            // Example materials for demo
            if (materials.length === 0 && !shareId) {
                document.getElementById('empty-state').style.display = 'block';
            }
        });
    </script>
</body>
</html>
